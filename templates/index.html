<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet Map with Sidebar</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
      body {
        display: flex; 
        margin: 0;
        padding: 0;
      }

      .map-container {
        width: 60%;
        height: 100vh;  /* Ensure the container takes up the full height */
        padding: 20px;
        box-sizing: border-box;  /* This ensures padding is included in the element's total size */
      }     

      #map {
        height: 90vh; 
        width: 100%;  
        background-color: #ffffff;
        border: 1px solid #ddd; 
      }

      #sidebar {
        width: 40%;     
        padding: 20px;  
        background-color: #f1f1f1; 
      }

      .box {
        height: auto;     
        background-color: #fff;
        border: 1px solid #ddd;
        margin-bottom: 20px; 
        padding: 10px; 
      }

      .plot-box {
        height: auto;
        background-color: #fff;
        border: 1px solid #ddd;
        margin-bottom: 20px;
        padding: 10px;
        text-align: center;
      }

      .plot-box img {
        max-width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="map-container">
      <div id="map"></div> <!-- The map container -->
    </div>

    <div id="sidebar">
      <div id="info" class="box">
        <label><input type="checkbox" id="income-checkbox"> Show Income</label><br>
        <label><input type="checkbox" id="age-checkbox"> Show Age</label><br>
        <label><input type="checkbox" id="suppliers-checkbox"> Show Supplier Locations</label>
      </div>
      <div class="plot-box" id="plot-box" style="display: none;">
        <img id="plot-img" alt="Data Plot">
      </div>
      <p id="coordinates"></p>
      <p id="zip-code"></p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      // Initialize the map 
      var map = L.map('map').setView([40.7934, -77.8600], 13);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Elements for displaying information
      var coordinatesBox = document.getElementById('coordinates');
      var zipCodeBox = document.getElementById('zip-code');
      var incomeCheckbox = document.getElementById('income-checkbox');
      var ageCheckbox = document.getElementById('age-checkbox');
      var suppliersCheckbox = document.getElementById('suppliers-checkbox');
      var plotImg = document.getElementById('plot-img');
      var plotBox = document.getElementById('plot-box');

      var currentCircle = null;
      var supplierMarkers = [];

      // Supplier data
      var supplierData = [
        { lat: 40.8246, lng: -77.8125 },
        { lat: 40.7878, lng: -77.8564 },
        { lat: 40.7842, lng: -77.8447 },
        { lat: 40.8120, lng: -77.9082 }
      ];

      // Function to toggle supplier markers
      function toggleSupplierMarkers(show) {
        if (show) {
          supplierData.forEach(function(supplier) {
            var marker = L.marker([supplier.lat, supplier.lng]).addTo(map);
            supplierMarkers.push(marker);
          });
        } else {
          supplierMarkers.forEach(function(marker) {
            map.removeLayer(marker);
          });
          supplierMarkers = [];
        }
      }

      // Ensure only one of the income or age checkboxes is selected at a time
      incomeCheckbox.addEventListener('change', function() {
        if (incomeCheckbox.checked) {
          ageCheckbox.checked = false;
          updatePlots(); // Update plots when selection changes
        }
      });

      ageCheckbox.addEventListener('change', function() {
        if (ageCheckbox.checked) {
          incomeCheckbox.checked = false;
          updatePlots(); // Update plots when selection changes
        }
      });

      // Event listener for map clicks
      map.on('click', function(e) {
        var lat = e.latlng.lat.toFixed(4);
        var lng = e.latlng.lng.toFixed(4);

        // Remove the current circle
        if (currentCircle) {
          map.removeLayer(currentCircle);
        }

        // Add a blue circle marker at the user-selected location
        currentCircle = L.circle([lat, lng], {
          color: 'blue',
          fillColor: 'blue',
          fillOpacity: 0.5,
          radius: 1
        }).addTo(map);

        // Get ZIP code using OpenCage API
        var apiKey = 'b3f99b81ff6844468e9c5f8333121a51'; 
        var apiUrl = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}`;

        fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            if (data.results.length > 0) {
              var components = data.results[0].components;
              var zip = components.postcode;

              coordinatesBox.innerHTML = 'Latitude: ' + lat + '<br>Longitude: ' + lng;
              zipCodeBox.innerHTML = 'ZIP Code: ' + zip;

              // Update plots based on ZIP code and user selection
              updatePlots(zip);
            } else {
              coordinatesBox.innerHTML = 'Latitude: ' + lat + '<br>Longitude: ' + lng;
              zipCodeBox.innerHTML = 'ZIP Code: Not found';
            }
          })
          .catch(error => {
            console.error('Error:', error);
            coordinatesBox.innerHTML = 'Latitude: ' + lat + '<br>Longitude: ' + lng;
            zipCodeBox.innerHTML = 'ZIP Code: Error retrieving data';
          });
      });

    function updatePlots(zip) {
    var showIncome = incomeCheckbox.checked;
    var showAge = ageCheckbox.checked;

    // Determine demographic type based on selected checkboxes
    var demographicType = showIncome ? 'income' : showAge ? 'age' : '';

    // Send zip code and demographic type to Flask for generating the graph
    if (demographicType && zip) {
      fetch('/generate_graph', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zipCode: zip, demographicType: demographicType })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          plotImg.src = `/static/graphs/${data.graphFilename}`;
          plotBox.style.display = 'block';
        } else {
          plotBox.style.display = 'none';
        }
      })
      .catch(error => console.error('Error:', error));
    } else {
      plotBox.style.display = 'none';
    }
  }

      // Event listener for suppliers checkbox
      suppliersCheckbox.addEventListener('change', function() {
        toggleSupplierMarkers(suppliersCheckbox.checked);
      });
    </script>
  </body>
</html>

